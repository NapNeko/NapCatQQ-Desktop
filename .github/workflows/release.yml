name: Build Release

on:
  # æ¨é€è§¦å‘ï¼šæŒ‰ tag æˆ–ç‰¹å®šåˆ†æ”¯ï¼ˆåˆå¹¶åˆ°åŒä¸€ä¸ª push ä¸‹ä»¥é¿å…é‡å¤ keyï¼‰
  push:
    tags:
      - 'v*.*.*'
    branches:
      - 'release/**'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.7.9 æˆ– v1.7.9)'
        required: false
        type: string
      skip_build:
        description: 'è·³è¿‡æ„å»ºï¼ˆä»…æ›´æ–°ç‰ˆæœ¬å·ï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:

  release:
    runs-on: windows-latest
    env:
      # å¼ºåˆ¶ Python åœ¨ runner ä¸Šä½¿ç”¨ UTF-8 I/Oï¼Œé¿å…å­è¿›ç¨‹/reader thread çš„ç¼–ç é”™è¯¯
      PYTHONUTF8: '1'
      PYTHONIOENCODING: 'utf-8'
    steps:
      - name: "æ£€å‡ºä»£ç "
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          submodules: true
          fetch-depth: 0
          # ä¿æŒå‡­æ®ä»¥ä¾¿åç»­æ­¥éª¤å¯ä»¥ pushï¼ˆä½¿ç”¨ä¸Šé¢æä¾›çš„ PERSONAL_ACCESS_TOKENï¼‰
          persist-credentials: true

      - name: "å®‰è£… uv"
        uses: astral-sh/setup-uv@v5

      - name: "è®¾ç½®Python 3.12"
        run: uv python install 3.12

      - name: "å®‰è£… OpenSSL (ç¡®ä¿ _ssl å¯ç”¨)"
        shell: pwsh
        run: |
          Write-Host "Installing OpenSSL via Chocolatey..."
          choco install openssl.light -y || choco install openssl -y
          # å°è¯•æŠŠå¸¸è§çš„ OpenSSL bin ç›®å½•åŠ å…¥å½“å‰ä¼šè¯ PATHï¼Œä¾¿äºåç»­æ­¥éª¤ï¼ˆpyinstaller/è¿è¡Œæ—¶ï¼‰èƒ½åŠ è½½åˆ° DLL
          $possible = @(
            "C:\\Program Files\\OpenSSL-Win64\\bin",
            "C:\\Program Files\\OpenSSL-Win32\\bin",
            "C:\\Program Files\\OpenSSL\\bin",
            "C:\\Program Files (x86)\\OpenSSL-Win32\\bin"
          )
          foreach ($p in $possible) {
            if (Test-Path $p) {
              Write-Host "Adding $p to PATH"
              $env:Path = "$($env:Path);$p"
              break
            }
          }
          Write-Host "PATH length:" $env:Path.Length

      - name: "å®‰è£…ä¾èµ–"
        run: |
          uv sync

      - name: "æå–ç‰ˆæœ¬å·"
        id: extract_version
        shell: pwsh
        run: |
          # ä»ä¸åŒæ¥æºæå–ç‰ˆæœ¬å·
          if ("${{ github.event_name }}" -eq "push" -and "${{ github.ref }}" -like "refs/tags/*") {
            # ä» tag æå–
            $VERSION = "${{ github.ref }}" -replace "refs/tags/", ""
          } elseif ("${{ github.event.inputs.version }}" -ne "") {
            # ä»æ‰‹åŠ¨è¾“å…¥æå–
            $VERSION = "${{ github.event.inputs.version }}"
            if (-not ($VERSION -like "v*")) {
              $VERSION = "v$VERSION"
            }
          } else {
            # ä» pyproject.toml æå–å½“å‰ç‰ˆæœ¬
            $content = Get-Content pyproject.toml -Raw
            if ($content -match 'version\s*=\s*"([^"]+)"') {
              $VERSION = "v$($matches[1])"
            } else {
              Write-Error "æ— æ³•æå–ç‰ˆæœ¬å·"
              exit 1
            }
          }
          
          echo "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          echo "æå–çš„ç‰ˆæœ¬å·: $VERSION"

      - name: "æ›´æ–°ç‰ˆæœ¬å·å’Œç”Ÿæˆæ›´æ–°æ—¥å¿—"
        if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || (github.event_name == 'workflow_dispatch' && github.event.inputs.version != '') }}
        shell: pwsh
        run: |
          $VERSION = "${{ steps.extract_version.outputs.VERSION }}"
          echo "æ›´æ–°ç‰ˆæœ¬å·åˆ° $VERSION"
          
          # è¿è¡Œç‰ˆæœ¬æ›´æ–°è„šæœ¬
          uv run python script/utils/update_version.py $VERSION
          
          # æäº¤æ›´æ”¹
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add pyproject.toml src/core/config/__init__.py docs/CHANGELOG.md
          git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·åˆ° $VERSION"
          
          # æ¨é€æ›´æ”¹ï¼ˆæ¨é€åˆ° master åˆ†æ”¯ï¼‰
          git push origin HEAD:master || echo "æ¨é€å¤±è´¥æˆ–æ— æ›´æ”¹"

      - name: "æ‰“åŒ…Debugç‰ˆæœ¬"
        if: ${{ !inputs.skip_build }}
        run: |
          uv run pyinstaller ./script/build_scripts/main_debug.spec

      - name: "æ‰“åŒ…Releaseç‰ˆæœ¬"
        if: ${{ !inputs.skip_build }}
        run: |
          uv run pyinstaller ./script/build_scripts/main.spec

      - name: "éªŒè¯æ–‡ä»¶å­˜åœ¨"
        if: ${{ !inputs.skip_build }}
        run: |
          Write-Host "æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨:"
          if (Test-Path "dist/NapCatQQ-Desktop-debug.exe") {
              Write-Host "âœ“ NapCatQQ-Desktop-debug.exe å­˜åœ¨"
              Write-Host "æ–‡ä»¶å¤§å°:" (Get-Item "dist/NapCatQQ-Desktop-debug.exe").Length "bytes"
          } else {
              Write-Host "âœ— NapCatQQ-Desktop-debug.exe ä¸å­˜åœ¨"
          }
          if (Test-Path "dist/NapCatQQ-Desktop.exe") {
              Write-Host "âœ“ NapCatQQ-Desktop.exe å­˜åœ¨"
              Write-Host "æ–‡ä»¶å¤§å°:" (Get-Item "dist/NapCatQQ-Desktop.exe").Length "bytes"
          } else {
              Write-Host "âœ— NapCatQQ-Desktop.exe ä¸å­˜åœ¨"
          }
          Write-Host "distç›®å½•å†…å®¹:"
          Get-ChildItem -Path "dist" -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }

      - name: "è®¾ç½®æ ‡ç­¾å’Œæ›´æ–°å†…å®¹"
        if: ${{ !inputs.skip_build && ((github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || (github.event_name == 'workflow_dispatch' && github.event.inputs.version != '')) }}
        id: get_info
        run: |
          $TAG_NAME = "${{ steps.extract_version.outputs.VERSION }}"
          $BODY = Get-Content -Path "docs/CHANGELOG.md" -Raw
          
          echo "TAG_NAME=$TAG_NAME" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "BODY<<EOF" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "$BODY" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "EOF" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: "åˆ›å»ºå‘å¸ƒè‰ç¨¿å¹¶ä¸Šä¼ æ–‡ä»¶"
        if: ${{ !inputs.skip_build && ((github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || (github.event_name == 'workflow_dispatch' && github.event.inputs.version != '')) }}
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ env.TAG_NAME }}
          name: NapCatQQ Desktop Release ${{ env.TAG_NAME }}
          body: ${{ env.BODY }}
          files: |
            dist/*.exe